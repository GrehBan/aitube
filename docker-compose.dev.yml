# File: docker-compose.dev.yml
services:
  web:
    volumes:
      - ./src:/app/src:z
      - ./alembic.ini:/app/alembic.ini:z
      - ./migrations:/app/migrations:z
    command: /bin/bash -c "uv run alembic upgrade head && uv run uvicorn src.app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app

  worker:
    volumes:
      - ./src:/app/src:z
    # Добавляем явное указание пути к конфигу celery через PYTHONPATH
    environment:
      - PYTHONPATH=/app
    command: uv run watchmedo auto-restart --directory=./src --pattern=*.py --recursive -- celery -A src.app.tasks.worker worker --loglevel=info

  nginx:
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro